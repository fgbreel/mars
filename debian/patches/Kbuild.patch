--- a/kernel/Kbuild
+++ b/kernel/Kbuild
@@ -4,36 +4,9 @@
 
 KBUILD_CFLAGS += -fdelete-null-pointer-checks
 
-# remove_this
-# The following is 1&1 specific. Don't use anywhere else.
-ifneq ($(KBUILD_EXTMOD),)
-  CONFIG_MARS := m
-# mars_config.h is generated by a simple Kconfig parser (gen_config.pl)
-# at build time.
-# It does not respect any Kconfig dependencies.
-# Therefore, it is unsafe. Use at your own risk!
-# It is ONLY used for out-of-tree builds.
-#
-extra-y	+= mars_config.h
-GEN_CONFIG_SCRIPT := $(src)/../scripts/gen_config.pl
-$(obj)/mars_config.h: $(obj)/buildtag.h
-$(obj)/mars_config.h: $(src)/Kconfig $(GEN_CONFIG_SCRIPT)
-	$(Q)$(kecho) "MARS: using compiler $($(CC) --version | head -1)"
-	$(CC) -v
-	$(Q)$(kecho) "MARS: Generating $@"
-	$(Q)set -e; \
-	if [ ! -x $(GEN_CONFIG_SCRIPT) ]; then \
-	    $(kecho) "MARS: cannot execute script $(GEN_CONFIG_SCRIPT)"; \
-	    /bin/false; \
-	fi; \
-	cat $< | $(GEN_CONFIG_SCRIPT) > $@;
-	cat $@;
-endif
-# end_remove_this
-
-obj-$(CONFIG_MARS)	+= mars.o
+obj-$(if $(KBUILD_EXTMOD),m,$(CONFIG_MARS)) := mars.o
 
-mars-objs :=				\
+mars-y :=				\
 	lamport.o			\
 	brick_say.o			\
 	brick_mem.o			\
@@ -66,7 +39,7 @@
 # We urge people to maintain it by including it in debug versions
 # (so the compiler may throw any complaints)
 
-mars-objs += 				\
+mars-y += 				\
 	mars_dummy.o			\
 	mars_check.o			\
 	mars_buf.o			\
@@ -74,22 +47,11 @@
 
 endif
 
-#
-# buildtag.h should be regenerated in every build.
-#
-# The version is determined by the following preference order:
-# 1) environment variable $MARSVERSION
-# 2) when git is available: git describe --tags
-# 3) if a file 'DISTVERSION' exists (out-of-tree tarball), use its content.
-# 4) otherwise "no-buildtag-available"
-#
-extra-y	+= buildtag.h
-$(obj)/buildtag.h: $(patsubst $(obj)/buildtag.h,,$(wildcard $(obj)/*.[ch])) $(obj)/*/*.[ch]
-	$(Q)$(kecho) "MARS: Generating $@"
-	$(Q)set -e; \
+extra-y := mars_config.h buildtag.h
+
+$(obj)/buildtag.h:
 	exec > $@;\
 	/bin/echo -e "/* Automatically generated -- DO NOT EDIT! */";\
-	cd $(src); \
 	if [ "$$MARSVERSION" != "" ]; then \
 		BUILDTAG="$$MARSVERSION"; \
 	elif git describe --tags >/dev/null 2>&1; then \
@@ -103,3 +65,13 @@
 	/bin/echo -e "#define BUILDHOST \"$$USER@`hostname`\"";\
 	/bin/echo -e "#define BUILDDATE \"$$(date '+%F %T')\""
 	cat $@;
+
+GEN_CONFIG_SCRIPT := $(obj)/gen_config.pl
+$(obj)/mars_config.h:
+	$(kecho) "building $@ ..."
+	if [ ! -x $(GEN_CONFIG_SCRIPT) ]; then \
+	    $(kecho) "MARS: cannot execute script $(GEN_CONFIG_SCRIPT)"; \
+	    /bin/false; \
+	fi; \
+	cat $(src)/Kconfig | $(GEN_CONFIG_SCRIPT) 2>/dev/null > $@;
+	cat $@
