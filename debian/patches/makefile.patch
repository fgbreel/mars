--- a/kernel/Makefile
+++ b/kernel/Makefile
@@ -5,6 +5,33 @@
 # By Benjamin KÃ¼bler <benjamin.kuebler@1und1.de>
 #
 # usage make [ KDIR =/path/to/kernel/source ]
+#
+obj-$(CONFIG_MARS)	+= mars.o
+
+mars-objs :=				\
+	lamport.o			\
+	brick_say.o			\
+	brick_mem.o			\
+	brick.o				\
+	mars_generic.o			\
+	lib_log.o			\
+	lib_rank.o			\
+	lib_limiter.o			\
+	lib_timing.o			\
+	lib_mapfree.o			\
+	mars_net.o			\
+	mars_server.o			\
+	mars_client.o			\
+	mars_aio.o			\
+	mars_sio.o			\
+	mars_bio.o			\
+	mars_if.o			\
+	mars_copy.o			\
+	mars_trans_logger.o		\
+	sy_old/sy_generic.o		\
+	sy_old/sy_net.o			\
+	sy_old/mars_proc.o		\
+	sy_old/mars_main.o
 
 ifneq ($(KERNELRELEASE),)
 
@@ -16,12 +43,12 @@
 
 MARSSRC := $(shell pwd)
 DESTDIR ?= /
-KDIR ?= /lib/modules/`uname -r`/build
+KDIR ?= /lib/modules/$(shell uname -r)/build
 
 .PHONY: greeting install default clean config
 
-default: greeting 
-	$(MAKE) -C $(KDIR) M=$(PWD)
+default: mars_config.h
+	$(MAKE) -C $(KDIR) M=$(PWD) modules
 
 greeting:
 	@echo "Building MARS Module again: KDIR=$(KDIR)" ;
@@ -38,4 +65,33 @@
 
 install:
 	$(MAKE) -C $(KDIR) M=$(PWD) modules_install
+
+extra-y	:= buildtag.h
+buildtag.h:
+	exec > $@;\
+	/bin/echo -e "/* Automatically generated -- DO NOT EDIT! */";\
+	if [ "$$MARSVERSION" != "" ]; then \
+		BUILDTAG="$$MARSVERSION"; \
+	elif git describe --tags >/dev/null 2>&1; then \
+		BUILDTAG="$$(git describe --tags)"; \
+	elif [ -e DISTVERSION ]; then \
+		BUILDTAG=$$(cat DISTVERSION); \
+	else \
+		BUILDTAG="no-buildtag-available"; \
+	fi; \
+	/bin/echo -e "#define BUILDTAG  \"$$BUILDTAG\"";\
+	/bin/echo -e "#define BUILDHOST \"$$USER@`hostname`\"";\
+	/bin/echo -e "#define BUILDDATE \"$$(date '+%F %T')\""
+	cat $@;
+
+extra-y	+= mars_config.h
+GEN_CONFIG_SCRIPT := $(MARSSRC)/gen_config.pl
+mars_config.h: buildtag.h
+	if [ ! -x $(GEN_CONFIG_SCRIPT) ]; then \
+	    $(kecho) "MARS: cannot execute script $(GEN_CONFIG_SCRIPT)"; \
+	    /bin/false; \
+	fi; \
+	cat $(MARSSRC)/Kconfig | $(GEN_CONFIG_SCRIPT) 2>/dev/null > $@;
+	cat $@;
+
 endif
